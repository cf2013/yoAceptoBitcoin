---
interface Props {
  companyName?: string;
  location?: string;
  description?: string;
  website?: string;
  telephone?: string;
}

const {
  companyName = "",
  location = "",
  description = "",
  website = "",
  telephone = ""
} = Astro.props;
---

<div class="container">
  <div class="call-to-action mt-24 mb-32 flex flex-col items-center gap-12 rounded-xl p-12 md:p-24">
    <h2 class="text-center text-3xl md:text-5xl">Añade tu establecimiento a este sitio.</h2>
    <button id="openModal" class="text-center text-lg">¡Vamos!</button>
  </div>
</div>

<!-- Modal -->
<div id="companyModal" class="modal hidden fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50">
  <div class="modal-content relative w-full max-w-2xl rounded-lg bg-white p-8 shadow-xl">
    <button id="closeModal" class="absolute right-4 top-4 text-2xl font-bold text-gray-500 hover:text-gray-700">&times;</button>
    <h3 class="mb-6 text-2xl font-bold text-center">Registra tu Empresa</h3>
    
    <form id="companyForm" class="space-y-6">
      <div>
        <label for="companyName" class="block text-sm font-medium text-gray-700">Nombre de la Empresa</label>
        <input 
          type="text" 
          id="companyName" 
          name="companyName" 
          required
          class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"
          placeholder="Ingresa el nombre de tu empresa"
        />
      </div>

      <div>
        <label for="location" class="block text-sm font-medium text-gray-700">Ubicación</label>
        <input 
          type="text" 
          id="location" 
          name="location" 
          required
          class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"
          placeholder="Ciudad, País"
        />
      </div>

      <div>
        <label for="description" class="block text-sm font-medium text-gray-700">Descripción</label>
        <textarea 
          id="description" 
          name="description" 
          required
          rows="3"
          class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"
          placeholder="Describe tu empresa"
        ></textarea>
      </div>

      <div>
        <label for="website" class="block text-sm font-medium text-gray-700">Sitio Web</label>
        <input 
          type="url" 
          id="website" 
          name="website" 
          required
          class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"
          placeholder="https://ejemplo.com"
        />
      </div>

      <div>
        <label for="telephone" class="block text-sm font-medium text-gray-700">Teléfono</label>
        <input 
          type="tel" 
          id="telephone" 
          name="telephone" 
          required
          class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"
          placeholder="+1234567890"
        />
      </div>

      <div class="flex justify-end space-x-4">
        <button 
          type="button" 
          id="cancelSubmit" 
          class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-100 rounded-md hover:bg-gray-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500"
        >
          Cancelar
        </button>
        <button 
          type="submit" 
          class="px-4 py-2 text-sm font-medium text-white bg-blue-600 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500"
        >
          Enviar
        </button>
      </div>
    </form>

    <!-- Success Message -->
    <div id="successMessage" class="hidden mt-4 p-4 bg-green-100 text-green-700 rounded-md">
      <p class="text-center">¡Tu empresa ha sido registrada exitosamente!</p>
    </div>
  </div>
</div>

<script>
  const modal = document.getElementById('companyModal');
  const openModalBtn = document.getElementById('openModal');
  const closeModalBtn = document.getElementById('closeModal');
  const cancelSubmitBtn = document.getElementById('cancelSubmit');
  const companyForm = document.getElementById('companyForm');
  const successMessage = document.getElementById('successMessage');

  function closeModal() {
    modal.classList.add('hidden');
    document.body.style.overflow = 'auto';
    companyForm.reset();
    successMessage.classList.add('hidden');
  }

  if (openModalBtn && modal && closeModalBtn && cancelSubmitBtn && companyForm && successMessage) {
    openModalBtn.addEventListener('click', () => {
      modal.classList.remove('hidden');
      document.body.style.overflow = 'hidden';
    });

    closeModalBtn.addEventListener('click', closeModal);
    cancelSubmitBtn.addEventListener('click', closeModal);

    modal.addEventListener('click', (e) => {
      if (e.target === modal) {
        closeModal();
      }
    });

    companyForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const formData = new FormData(companyForm);
      const data = Object.fromEntries(formData);

      try {
        const response = await fetch('/api/companies', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(data)
        });

        if (!response.ok) {
          const errorData = await response.json();
          throw new Error(errorData.error || 'Error submitting form');
        }

        const result = await response.json();
        
        successMessage.classList.remove('hidden');
        companyForm.classList.add('hidden');
        
        // Reset form and close modal after 2 seconds
        setTimeout(() => {
          closeModal();
        }, 2000);
      } catch (error) {
        console.error('Error submitting form:', error);
        alert(error.message || 'Hubo un error al enviar el formulario. Por favor, intenta de nuevo.');
      }
    });
  }
</script>

<style lang="scss">
  .call-to-action {
    color: var(--neutral-700);
    background-image: linear-gradient(40deg, var(--primary-100), var(--secondary-200));
  }

  .call-to-action button {
    padding: 1rem;
    color: var(--neutral-600);
    font-weight: bold;
    border: 3px solid var(--neutral-600);
    border-radius: 3px;
    text-decoration: none;
    transition: color 0.15s ease-in-out, background-color 0.15s ease-in-out;
    cursor: pointer;
    background: none;

    &:where(:hover, :focus) {
      color: var(--neutral-100);
      background-color: var(--neutral-700);
      text-decoration: underline;
    }
  }

  .modal {
    transition: opacity 0.3s ease-in-out;
  }

  .modal-content {
    animation: modalSlideIn 0.3s ease-out;
  }

  @keyframes modalSlideIn {
    from {
      transform: translateY(-20px);
      opacity: 0;
    }
    to {
      transform: translateY(0);
      opacity: 1;
    }
  }

  input, textarea {
    border: 1px solid #e5e7eb;
    padding: 0.5rem;
    width: 100%;
    border-radius: 0.375rem;
    transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;

    &:focus {
      outline: none;
      border-color: #3b82f6;
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }
  }
</style>
